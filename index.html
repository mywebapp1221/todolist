<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  // ===== Supabase =====
  const supabaseUrl = "https://qzobchxakdvubfkdwxxf.supabase.co";
  const supabaseKey = "sb_publishable_L39SGNHMqWijT5_cX3BwDA_J5JWnrPA";

  // ★二重読み込みでも落ちないようにする（重要）
  window.__sb = window.__sb || window.supabase.createClient(supabaseUrl, supabaseKey);
  const supabase = window.__sb;

  // ===== state =====
  let view = "day";
  let rateChart = null;

  // ===== dom =====
  const tabs = [...document.querySelectorAll(".tab")];
  const scheduleTitle = document.getElementById("scheduleTitle");
  const todoTitle = document.getElementById("todoTitle");
  const rangeLabel = document.getElementById("rangeLabel");
  const statusLine = document.getElementById("statusLine");

  const schDate = document.getElementById("schDate");
  const schTime = document.getElementById("schTime");
  const schText = document.getElementById("schText");
  const addScheduleBtn = document.getElementById("addSchedule");
  const scheduleBody = document.getElementById("scheduleBody");

  const todoText = document.getElementById("todoText");
  const todoDate = document.getElementById("todoDate");
  const addTodoBtn = document.getElementById("addTodo");
  const todoBody = document.getElementById("todoBody");

  const refreshAllBtn = document.getElementById("refreshAll");
  const markAllDoneBtn = document.getElementById("markAllDone");

  // ===== utils =====
  const pad = (n) => String(n).padStart(2,"0");
  const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const todayStr = () => ymd(new Date());

  function startOfWeek(date) {
    const d = new Date(date);
    const day = (d.getDay() + 6) % 7;
    d.setDate(d.getDate() - day);
    d.setHours(0,0,0,0);
    return d;
  }
  function endOfWeek(date) {
    const s = startOfWeek(date);
    const e = new Date(s);
    e.setDate(e.getDate() + 6);
    e.setHours(23,59,59,999);
    return e;
  }
  function startOfMonth(date) {
    const d = new Date(date);
    d.setDate(1); d.setHours(0,0,0,0);
    return d;
  }
  function endOfMonth(date) {
    const d = new Date(date);
    d.setMonth(d.getMonth()+1, 0);
    d.setHours(23,59,59,999);
    return d;
  }

  function currentRange() {
    const now = new Date();
    if (view === "day") {
      const a = new Date(now); a.setHours(0,0,0,0);
      const b = new Date(now); b.setHours(23,59,59,999);
      return { a, b, label: "今日" };
    }
    if (view === "week") {
      const a = startOfWeek(now);
      const b = endOfWeek(now);
      const label = `${a.getFullYear()}/${pad(a.getMonth()+1)}/${pad(a.getDate())} - ${b.getFullYear()}/${pad(b.getMonth()+1)}/${pad(b.getDate())}`;
      return { a, b, label: `今週（${label}）` };
    }
    const a = startOfMonth(now);
    const b = endOfMonth(now);
    return { a, b, label: `今月（${a.getFullYear()}/${pad(a.getMonth()+1)}）` };
  }

  function setTitles() {
    const jp = view === "day" ? "日" : view === "week" ? "週" : "月";
    scheduleTitle.textContent = `スケジュール（${jp}）`;
    todoTitle.textContent = `ToDo（${jp}）`;
    rangeLabel.textContent = currentRange().label;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setStatus(msg, type="") {
    const cls = type === "ok" ? "ok" : type === "err" ? "err" : type === "warn" ? "warn" : "";
    statusLine.className = `mini ${cls}`;
    statusLine.textContent = msg || "";
  }

  // ===== Supabase ops =====
  async function insertSchedule(date, time, text) {
    const { error } = await supabase.from("schedules").insert({ date, time: time || null, text });
    if (error) throw error;
  }
  async function deleteSchedule(id) {
    const { error } = await supabase.from("schedules").delete().eq("id", id);
    if (error) throw error;
  }
  async function fetchSchedules(fromYmd, toYmd) {
    const { data, error } = await supabase
      .from("schedules")
      .select("id, date, time, text")
      .gte("date", fromYmd)
      .lte("date", toYmd)
      .order("date", { ascending: true })
      .order("time", { ascending: true });
    if (error) throw error;
    return data ?? [];
  }

  async function insertTodo(text, planned_date) {
    const { error } = await supabase.from("todos").insert({
      text, planned_date, done:false, completed_at:null
    });
    if (error) throw error;
  }
  async function deleteTodo(id) {
    const { error } = await supabase.from("todos").delete().eq("id", id);
    if (error) throw error;
  }
  async function toggleTodo(id, done) {
    const payload = done
      ? { done: true, completed_at: new Date().toISOString() }
      : { done: false, completed_at: null };
    const { error } = await supabase.from("todos").update(payload).eq("id", id);
    if (error) throw error;
  }
  async function fetchTodos(fromYmd, toYmd) {
    const { data, error } = await supabase
      .from("todos")
      .select("id, text, planned_date, done")
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd)
      .order("done", { ascending: true })
      .order("planned_date", { ascending: true })
      .order("created_at", { ascending: true });
    if (error) throw error;
    return data ?? [];
  }
  async function markAllDoneInRange(fromYmd, toYmd) {
    const { error } = await supabase
      .from("todos")
      .update({ done: true, completed_at: new Date().toISOString() })
      .eq("done", false)
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd);
    if (error) throw error;
  }

  async function renderSchedules() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchSchedules(fromYmd, toYmd);

    scheduleBody.innerHTML = rows.map(x => `
      <tr>
        <td class="nowrap">${escapeHtml(x.date)}</td>
        <td class="nowrap">${x.time ? escapeHtml(String(x.time).slice(0,5)) : ""}</td>
        <td>${escapeHtml(x.text)}</td>
        <td class="nowrap"><button class="btn danger" data-del-sch="${x.id}">削除</button></td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="mini">（この範囲のスケジュールはまだありません）</td></tr>`;

    scheduleBody.querySelectorAll("[data-del-sch]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        try{
          await deleteSchedule(btn.getAttribute("data-del-sch"));
          await renderAll();
          setStatus("スケジュールを削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  async function renderTodos() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchTodos(fromYmd, toYmd);

    todoBody.innerHTML = rows.map(t => `
      <tr>
        <td class="nowrap"><input type="checkbox" data-todo-check="${t.id}" ${t.done ? "checked":""}></td>
        <td class="${t.done ? "done":""}">${escapeHtml(t.text)}</td>
        <td class="nowrap">${escapeHtml(t.planned_date)}</td>
        <td class="nowrap"><button class="btn danger" data-del-todo="${t.id}">削除</button></td>
      </tr>
    `).join("") || `<tr><td colspan="4" class="mini">（この範囲のToDoはまだありません）</td></tr>`;

    todoBody.querySelectorAll("[data-todo-check]").forEach(ch=>{
      ch.addEventListener("change", async () => {
        try{
          await toggleTodo(ch.getAttribute("data-todo-check"), ch.checked);
          await renderAll();
          setStatus(ch.checked ? "完了にしました" : "未完了に戻しました", "ok");
        }catch(e){
          setStatus(`更新失敗：${e.message}`, "err");
        }
      });
    });

    todoBody.querySelectorAll("[data-del-todo]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        try{
          await deleteTodo(btn.getAttribute("data-del-todo"));
          await renderAll();
          setStatus("ToDoを削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  async function renderRateChartForView() {
    const { a, b, label } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const todos = await fetchTodos(fromYmd, toYmd);
    const total = todos.length;
    const done = todos.filter(t => t.done).length;
    const rate = total ? Math.round(done / total * 100) : 0;

    if (rateChart) rateChart.destroy();
    rateChart = new Chart(document.getElementById("rateChart"), {
      type: "bar",
      data: { labels: [label], datasets: [{ label: "達成率(%)", data: [rate] }] },
      options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
  }

  async function renderAll() {
    setTitles();
    setStatus("同期中…", "warn");
    try{
      await renderSchedules();
      await renderTodos();
      await renderRateChartForView();
      setStatus("同期OK", "ok");
    }catch(e){
      setStatus(`エラー：${e.message}`, "err");
      console.error(e);
    }
  }

  // init
  schDate.value = todayStr();
  todoDate.value = todayStr();

  tabs.forEach(t=>{
    t.addEventListener("click", async ()=>{
      view = t.dataset.view;
      tabs.forEach(x=>x.classList.toggle("active", x===t));
      await renderAll();
    });
  });

  addScheduleBtn.addEventListener("click", async ()=>{
    const date = schDate.value || todayStr();
    const time = schTime.value || "";
    const text = (schText.value || "").trim();
    if(!text) return alert("内容を入れてね");
    try{
      await insertSchedule(date, time, text);
      schText.value = "";
      await renderAll();
      setStatus("スケジュールを追加しました", "ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`, "err");
    }
  });

  addTodoBtn.addEventListener("click", async ()=>{
    const text = (todoText.value || "").trim();
    const planned = todoDate.value || todayStr();
    if(!text) return alert("ToDoを入れてね");
    try{
      await insertTodo(text, planned);
      todoText.value = "";
      await renderAll();
      setStatus("ToDoを追加しました", "ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`, "err");
    }
  });

  refreshAllBtn.addEventListener("click", async ()=>{ await renderAll(); });

  markAllDoneBtn.addEventListener("click", async ()=>{
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    if(!confirm("この範囲のToDoを全部完了にする？")) return;
    try{
      await markAllDoneInRange(fromYmd, toYmd);
      await renderAll();
      setStatus("範囲内ToDoを全部完了にしました", "ok");
    }catch(e){
      setStatus(`一括完了失敗：${e.message}`, "err");
    }
  });

  renderAll();
</script>

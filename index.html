<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>スケジュール & ToDo（日/週/月）+ 達成率</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --ok:#10b981; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.08);
      --r:16px; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:24px auto;padding:0 14px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:8px;background:var(--chip);padding:6px;border-radius:999px}
    .tab{border:0;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:800}
    .tab.active{background:var(--card);color:var(--text);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card h2{font-size:14px;margin:0;padding:12px 14px;border-bottom:1px solid var(--line);color:var(--muted)}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    input, button{font:inherit;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    input[type="time"], input[type="date"]{padding:9px 10px}
    button{cursor:pointer;font-weight:900}
    .btn{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:#fff;color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn.ok{background:var(--ok);color:#fff;border-color:transparent}
    .mini{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;background:#fafafa}
    .spacer{flex:1}
    .nowrap{white-space:nowrap}
    .done{text-decoration:line-through;color:var(--muted)}
    .okText{color:#047857}
    .warnText{color:#b45309}
    .errText{color:#b91c1c}
    .fatal{margin:14px 0;padding:12px 14px;border:1px solid #fecaca;background:#fff1f2;border-radius:12px;display:none}
    .fatal b{display:block;margin-bottom:6px}
    code{background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px}

    /* ===== スケジュール表示 ===== */
    #scheduleView{margin-top:10px}
    .sv-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px}
    .sv-title{font-weight:900}
    .sv-sub{font-size:12px;color:var(--muted);margin-top:4px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sv-actions{margin-left:auto;display:flex;gap:8px}
    .sv-actions button{padding:6px 10px;border-radius:10px}

    /* 月：カレンダー */
    .monthHeader{display:flex;align-items:center;gap:10px;flex-wrap:wrap}
    .monthHeader .mBtn{padding:8px 10px;border-radius:12px}
    .month{display:grid;grid-template-columns:repeat(7,1fr);gap:8px;margin-top:10px}
    .mday{border:1px solid var(--line);border-radius:14px;min-height:104px;padding:8px;background:#fff;cursor:pointer}
    .mday .num{font-weight:900}
    .mday .dots{margin-top:6px;display:flex;gap:4px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:999px;background:#93c5fd}      /* schedule */
    .dot.todo{background:#86efac}                                        /* todo */
    .mday.off{opacity:.35}
    .mday.today{outline:3px solid #bfdbfe}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .legend .item{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
    .legend .sw{width:10px;height:10px;border-radius:999px;background:#93c5fd;border:1px solid var(--line)}
    .legend .sw.todo{background:#86efac}

    /* 月：一覧 */
    .monthList{margin-top:10px}
    .monthRow{display:flex;gap:10px;align-items:center;justify-content:space-between;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff;margin-top:8px}
    .monthRow .left{min-width:0}
    .monthRow .title{font-weight:900}
    .monthRow .sub{font-size:12px;color:var(--muted);margin-top:3px}
    .monthRow button{padding:6px 10px;border-radius:10px}

    /* ToDo */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:900;background:#fafafa}
    tr:last-child td{border-bottom:0}
    .todo-tools{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>スケジュール & ToDo + 達成率</h1>
    <div class="tabs" role="tablist" aria-label="view">
      <button class="tab active" data-view="day">日</button>
      <button class="tab" data-view="week">週</button>
      <button class="tab" data-view="month">月</button>
    </div>
  </header>

  <div id="fatal" class="fatal">
    <b>エラーで止まっています</b>
    <div class="mini" id="fatalMsg"></div>
    <div class="mini" style="margin-top:8px">※ DevTools → Console の赤い行も貼ってOK</div>
  </div>

  <p class="mini" style="margin:10px 4px 0">
    保存先：Supabase（ログイン無し） / 表示：日・週・月で切り替え
  </p>

  <div class="grid">
    <!-- Schedule -->
    <section class="card">
      <h2 id="scheduleTitle">スケジュール（日）</h2>
      <div class="body">
        <div class="row">
          <div>
            <div class="mini">日付</div>
            <input id="schDate" type="date">
          </div>
          <div>
            <div class="mini">時間</div>
            <input id="schTime" type="time">
          </div>
          <div style="flex:1;min-width:240px">
            <div class="mini">内容</div>
            <input id="schText" placeholder="例：英単語 30分 / 面接練習 / K.ARTS" />
          </div>
          <button class="btn" id="addSchedule">追加</button>
        </div>

        <div class="row" style="margin:12px 0 0; align-items:center">
          <span class="pill">表示範囲：<b id="rangeLabel">今日</b></span>
          <span class="spacer"></span>
          <button class="btn ghost" id="refreshAll">更新</button>
        </div>

        <div id="scheduleView"></div>
        <p class="mini" id="statusLine"></p>
      </div>
    </section>

    <!-- Todo + Chart -->
    <section class="card">
      <h2 id="todoTitle">ToDo（日）</h2>
      <div class="body">
        <div class="row">
          <div style="flex:1;min-width:240px">
            <div class="mini">ToDo</div>
            <input id="todoText" placeholder="例：数学 10問 / GitHubにpush" />
          </div>
          <div>
            <div class="mini">予定日</div>
            <input id="todoDate" type="date">
          </div>
          <button class="btn" id="addTodo">追加</button>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th class="nowrap">完了</th>
                <th>内容</th>
                <th class="nowrap">予定日</th>
                <th class="nowrap">操作</th>
              </tr>
            </thead>
            <tbody id="todoBody"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>達成率（日/週/月）</h2>
          <div class="body">
            <canvas id="rateChart" height="120"></canvas>
            <p class="mini">範囲内ToDoの「完了数 / 総数」から達成率(%)を計算</p>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  function showFatal(err){
    console.error(err);
    const box = document.getElementById("fatal");
    const msg = document.getElementById("fatalMsg");
    box.style.display = "block";
    msg.innerHTML = `原因：<code>${String(err?.message || err)}</code>`;
  }
  window.addEventListener("error", (e)=>showFatal(e.error || e.message));
  window.addEventListener("unhandledrejection", (e)=>showFatal(e.reason || e));

  const SUPABASE_URL = "https://vxtrnewebvqdgnknktdt.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dHJuZXdlYnZxZGdua25rdGR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDM0MDIsImV4cCI6MjA4MTgxOTQwMn0.1MtxmKyLVSp_LfyfE3jXn8TBKRf0G6WdMFLxUrM_TsM";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  let view = "day";
  let rateChart = null;
  let monthCursor = new Date();

  const tabs = [...document.querySelectorAll(".tab")];
  const scheduleTitle = document.getElementById("scheduleTitle");
  const todoTitle = document.getElementById("todoTitle");
  const rangeLabel = document.getElementById("rangeLabel");
  const statusLine = document.getElementById("statusLine");
  const scheduleView = document.getElementById("scheduleView");

  const schDate = document.getElementById("schDate");
  const schTime = document.getElementById("schTime");
  const schText = document.getElementById("schText");
  const addScheduleBtn = document.getElementById("addSchedule");

  const todoText = document.getElementById("todoText");
  const todoDate = document.getElementById("todoDate");
  const addTodoBtn = document.getElementById("addTodo");
  const todoBody = document.getElementById("todoBody");

  const refreshAllBtn = document.getElementById("refreshAll");

  const pad = (n) => String(n).padStart(2,"0");
  const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const todayStr = () => ymd(new Date());

  function dateFromYmd(s){
    const [y,m,d] = String(s).split("-").map(Number);
    return new Date(y, m-1, d);
  }
  function addDays(date, n){
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
  }
  function startOfMonth(date){
    const d = new Date(date); d.setDate(1); d.setHours(0,0,0,0); return d;
  }
  function endOfMonth(date){
    const d = new Date(date); d.setMonth(d.getMonth()+1, 0); d.setHours(23,59,59,999); return d;
  }

  function syncSelectedDate(v){
    const val = v || todayStr();
    schDate.value = val;
    todoDate.value = val;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setStatus(msg, type=""){
    const cls = type === "ok" ? "okText" : type === "err" ? "errText" : type === "warn" ? "warnText" : "";
    statusLine.className = `mini ${cls}`;
    statusLine.textContent = msg || "";
  }

  function currentRange(){
    if(view === "day"){
      const key = (schDate.value || todayStr());
      const base = dateFromYmd(key);
      const a = new Date(base); a.setHours(0,0,0,0);
      const b = new Date(base); b.setHours(23,59,59,999);
      const label = (key === todayStr()) ? "今日" : `${a.getFullYear()}/${pad(a.getMonth()+1)}/${pad(a.getDate())}`;
      return { a, b, label };
    }
    if(view === "month"){
      const a = startOfMonth(monthCursor);
      const b = endOfMonth(monthCursor);
      return { a, b, label: `今月（${a.getFullYear()}/${pad(a.getMonth()+1)}）` };
    }
    // 週は簡易：今週ではなく、今日〜6日後（必要なら週表示を戻せる）
    const a = dateFromYmd(todayStr());
    const b = addDays(a, 6); b.setHours(23,59,59,999);
    return { a, b, label: "今週（簡易）" };
  }

  function setTitles(){
    const jp = view === "day" ? "日" : view === "week" ? "週" : "月";
    scheduleTitle.textContent = `スケジュール（${jp}）`;
    todoTitle.textContent = `ToDo（${jp}）`;
    rangeLabel.textContent = currentRange().label;
  }

  async function insertSchedule(date, time, text){
    const { error } = await sb.from("schedules").insert({ date, time: time || null, text });
    if(error) throw error;
  }
  async function deleteSchedule(id){
    const { error } = await sb.from("schedules").delete().eq("id", id);
    if(error) throw error;
  }
  async function fetchSchedules(fromYmd, toYmd){
    const { data, error } = await sb
      .from("schedules")
      .select("id, date, time, text")
      .gte("date", fromYmd)
      .lte("date", toYmd)
      .order("date", { ascending:true })
      .order("time", { ascending:true });
    if(error) throw error;
    return data ?? [];
  }

  async function insertTodo(text, planned_date){
    const { error } = await sb.from("todos").insert({ text, planned_date, done:false, completed_at:null });
    if(error) throw error;
  }
  async function deleteTodo(id){
    const { error } = await sb.from("todos").delete().eq("id", id);
    if(error) throw error;
  }
  async function toggleTodo(id, done){
    const payload = done ? { done:true, completed_at:new Date().toISOString() } : { done:false, completed_at:null };
    const { error } = await sb.from("todos").update(payload).eq("id", id);
    if(error) throw error;
  }
  async function fetchTodos(fromYmd, toYmd){
    const { data, error } = await sb
      .from("todos")
      .select("id, text, planned_date, done, created_at")
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd)
      .order("done", { ascending:true })
      .order("planned_date", { ascending:true })
      .order("created_at", { ascending:true });
    if(error) throw error;
    return data ?? [];
  }

  // ===== 月：カレンダー + 一覧（削除ボタン） =====
  function renderScheduleMonthCalendar(schedules, todos){
    scheduleView.innerHTML = "";

    const a = startOfMonth(monthCursor);
    const y = a.getFullYear();
    const m = a.getMonth();

    const header = document.createElement("div");
    header.className = "monthHeader";
    header.innerHTML = `
      <button class="btn ghost mBtn" id="prevMonth">←</button>
      <div class="sv-card" style="padding:8px 12px"><b>${y}年 ${m+1}月</b></div>
      <button class="btn ghost mBtn" id="nextMonth">→</button>
      <span class="spacer"></span>
      <span class="legend">
        <span class="item"><span class="sw"></span>予定</span>
        <span class="item"><span class="sw todo"></span>ToDo</span>
      </span>
      <span class="pill">クリックで日へ</span>
    `;
    scheduleView.appendChild(header);

    // ---- 月のスケジュール一覧（ここで削除できる）----
    const listBox = document.createElement("div");
    listBox.className = "monthList";
    const sortedSch = schedules.slice().sort((x,y)=>{
      const a = (x.date||"").localeCompare(y.date||"");
      if(a!==0) return a;
      return (x.time||"99:99").localeCompare(y.time||"99:99");
    });

    listBox.innerHTML = `
      <div class="sv-card">
        <div class="sv-title">この月のスケジュール一覧（削除OK）</div>
        <div class="mini" style="margin-top:4px">※ 削除するとカレンダーの点もすぐ減ります</div>
      </div>
    `;
    if(!sortedSch.length){
      const empty = document.createElement("div");
      empty.className = "mini";
      empty.style.marginTop = "8px";
      empty.textContent = "（この月のスケジュールはまだありません）";
      listBox.appendChild(empty);
    }else{
      for(const r of sortedSch){
        const row = document.createElement("div");
        row.className = "monthRow";
        row.innerHTML = `
          <div class="left">
            <div class="title">${escapeHtml(r.date)} ${escapeHtml(r.time ? String(r.time).slice(0,5) : "")}　${escapeHtml(r.text||"")}</div>
            <div class="sub">id: ${escapeHtml(r.id)}</div>
          </div>
          <div class="right">
            <button class="btn danger" data-del-sch="${r.id}">削除</button>
          </div>
        `;
        listBox.appendChild(row);
      }
    }
    scheduleView.appendChild(listBox);

    // ---- カレンダー ----
    const first = new Date(y, m, 1);
    const startDow = first.getDay(); // 0=Sun
    const start = new Date(y, m, 1 - startDow);

    const schMap = new Map();
    for(const r of schedules){
      if(!schMap.has(r.date)) schMap.set(r.date, []);
      schMap.get(r.date).push(r);
    }
    const todoMap = new Map();
    for(const t of todos){
      if(!todoMap.has(t.planned_date)) todoMap.set(t.planned_date, []);
      todoMap.get(t.planned_date).push(t);
    }

    const cal = document.createElement("div");
    cal.className = "month";

    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const k = ymd(d);
      const inMonth = d.getMonth() === m;

      const cell = document.createElement("div");
      cell.className = "mday" + (inMonth ? "" : " off") + (k===todayStr() ? " today" : "");

      const schList = schMap.get(k) || [];
      const tdList = todoMap.get(k) || [];

      cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="dots"></div>`;
      const dots = cell.querySelector(".dots");

      for(let j=0;j<Math.min(schList.length, 6);j++){
        const dot = document.createElement("span");
        dot.className = "dot";
        dots.appendChild(dot);
      }
      for(let j=0;j<Math.min(tdList.length, 6);j++){
        const dot = document.createElement("span");
        dot.className = "dot todo";
        dots.appendChild(dot);
      }

      if(schList.length || tdList.length){
        const undone = tdList.filter(x=>!x.done).length;
        const t = document.createElement("div");
        t.className = "mini";
        t.style.marginTop = "6px";
        const parts = [];
        if(schList.length) parts.push(`予定${schList.length}`);
        if(tdList.length) parts.push(`ToDo${tdList.length}（未${undone}）`);
        t.textContent = parts.join(" / ");
        cell.appendChild(t);
      }

      cell.addEventListener("click", ()=>{
        syncSelectedDate(k);
        setView("day");
      });

      cal.appendChild(cell);
    }

    scheduleView.appendChild(cal);

    document.getElementById("prevMonth").addEventListener("click", async ()=>{
      monthCursor = new Date(monthCursor.getFullYear(), monthCursor.getMonth()-1, 1);
      await renderAll();
    });
    document.getElementById("nextMonth").addEventListener("click", async ()=>{
      monthCursor = new Date(monthCursor.getFullYear(), monthCursor.getMonth()+1, 1);
      await renderAll();
    });

    // 月一覧の削除ボタン
    scheduleView.querySelectorAll("[data-del-sch]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del-sch");
        if(!confirm("このスケジュールを削除する？")) return;
        try{
          await deleteSchedule(id);
          await renderAll(); // ★これで月ドットも即更新
          setStatus("スケジュールを削除しました（カレンダーも更新）", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  // ===== 日：簡易リスト（削除OK） =====
  function renderScheduleDayList(rows){
    scheduleView.innerHTML = "";
    const dayKey = schDate.value || todayStr();
    const dayRows = rows.filter(r => r.date === dayKey)
      .sort((a,b)=> (a.time||"99:99").localeCompare(b.time||"99:99"));

    const head = document.createElement("div");
    head.className = "sv-card";
    head.innerHTML = `<div class="sv-title">${escapeHtml(dayKey)} のスケジュール</div>`;
    scheduleView.appendChild(head);

    if(!dayRows.length){
      const empty = document.createElement("div");
      empty.className = "sv-card";
      empty.style.marginTop = "10px";
      empty.innerHTML = `<div class="mini">（この日のスケジュールはまだありません）</div>`;
      scheduleView.appendChild(empty);
      return;
    }

    for(const r of dayRows){
      const c = document.createElement("div");
      c.className = "sv-card";
      c.style.marginTop = "10px";
      c.innerHTML = `
        <div class="sv-title">${escapeHtml(r.time ? String(r.time).slice(0,5) : "（時間なし）")}　${escapeHtml(r.text||"")}</div>
        <div class="sv-sub">
          <span>${escapeHtml(r.date)}</span>
          <span class="spacer"></span>
          <span class="sv-actions">
            <button class="btn danger" data-del-sch="${r.id}">削除</button>
          </span>
        </div>
      `;
      scheduleView.appendChild(c);
    }

    scheduleView.querySelectorAll("[data-del-sch]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-del-sch");
        if(!confirm("このスケジュールを削除する？")) return;
        try{
          await deleteSchedule(id);
          await renderAll();
          setStatus("削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  async function renderSchedules(){
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchSchedules(fromYmd, toYmd);

    if(view === "day") renderScheduleDayList(rows);
    else if(view === "month") renderScheduleMonthCalendar(rows, []);
    else renderScheduleDayList(rows);
  }

  async function renderTodos(){
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchTodos(fromYmd, toYmd);

    todoBody.innerHTML = rows.map(t => `
      <tr>
        <td class="nowrap">
          <input type="checkbox" data-todo-check="${t.id}" ${t.done ? "checked":""}>
        </td>
        <td class="${t.done ? "done":""}">${escapeHtml(t.text)}</td>
        <td class="nowrap">${escapeHtml(t.planned_date)}</td>
        <td class="nowrap">
          <button class="btn danger" data-del-todo="${t.id}">削除</button>
        </td>
      </tr>
    `).join("") || `
      <tr><td colspan="4" class="mini">（この範囲のToDoはまだありません）</td></tr>
    `;

    todoBody.querySelectorAll("[data-todo-check]").forEach(ch=>{
      ch.addEventListener("change", async () => {
        try{
          await toggleTodo(ch.getAttribute("data-todo-check"), ch.checked);
          await renderAll();
          setStatus(ch.checked ? "完了にしました" : "未完了に戻しました", "ok");
        }catch(e){
          setStatus(`更新失敗：${e.message}`, "err");
        }
      });
    });

    todoBody.querySelectorAll("[data-del-todo]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-todo");
        if(!confirm("このToDoを削除する？")) return;
        try{
          await deleteTodo(id);
          await renderAll();
          setStatus("ToDoを削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  async function renderRateChartForView(){
    const { a, b, label } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);

    const todos = await fetchTodos(fromYmd, toYmd);
    const total = todos.length;
    const done = todos.filter(t => t.done).length;
    const rate = total ? Math.round(done / total * 100) : 0;

    if(rateChart) rateChart.destroy();
    rateChart = new Chart(document.getElementById("rateChart"), {
      type: "bar",
      data: { labels: [label], datasets: [{ label:"達成率(%)", data:[rate] }] },
      options: { scales: { y: { beginAtZero:true, max:100 } } }
    });
  }

  async function renderAll(){
    setTitles();
    setStatus("同期中…","warn");
    try{
      const { a, b } = currentRange();
      const fromYmd = ymd(a), toYmd = ymd(b);

      if(view === "month"){
        const [schedules, todos] = await Promise.all([
          fetchSchedules(fromYmd, toYmd),
          fetchTodos(fromYmd, toYmd),
        ]);
        renderScheduleMonthCalendar(schedules, todos);
      }else{
        await renderSchedules();
      }

      await renderTodos();
      await renderRateChartForView();
      setStatus("同期OK","ok");
    }catch(e){
      setStatus(`エラー：${e.message}`,"err");
      console.error(e);
    }
  }

  function setView(v){
    view = v;
    tabs.forEach(t=>t.classList.toggle("active", t.dataset.view===v));
    renderAll();
  }

  // init
  syncSelectedDate(todayStr());

  schDate.addEventListener("change", ()=>{
    if(view === "day") syncSelectedDate(schDate.value || todayStr());
    if(view === "day") renderAll();
  });
  todoDate.addEventListener("change", ()=>{
    if(view === "day") syncSelectedDate(todoDate.value || todayStr());
    if(view === "day") renderAll();
  });

  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      if(t.dataset.view==="month") monthCursor = new Date(monthCursor.getFullYear(), monthCursor.getMonth(), 1);
      setView(t.dataset.view);
    });
  });

  addScheduleBtn.addEventListener("click", async ()=>{
    const date = schDate.value || todayStr();
    const time = schTime.value || "";
    const text = (schText.value || "").trim();
    if(!text) return alert("内容を入れてね");
    try{
      await insertSchedule(date, time, text);
      schText.value = "";
      await renderAll();
      setStatus("スケジュールを追加しました","ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`,"err");
    }
  });

  addTodoBtn.addEventListener("click", async ()=>{
    const text = (todoText.value || "").trim();
    const planned = (todoDate.value || schDate.value || todayStr());
    if(!text) return alert("ToDoを入れてね");
    try{
      await insertTodo(text, planned);
      todoText.value = "";
      await renderAll();
      setStatus("ToDoを追加しました","ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`,"err");
    }
  });

  refreshAllBtn.addEventListener("click", async ()=>{ await renderAll(); });

  renderAll();
</script>
</body>
</html>

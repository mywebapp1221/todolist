<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« & ToDoï¼ˆæ—¥/é€±/æœˆï¼‰+ é”æˆç‡</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --ok:#10b981; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.08);
      --r:16px; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:24px auto;padding:0 14px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:8px;background:var(--chip);padding:6px;border-radius:999px}
    .tab{border:0;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:800}
    .tab.active{background:var(--card);color:var(--text);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card h2{font-size:14px;margin:0;padding:12px 14px;border-bottom:1px solid var(--line);color:var(--muted)}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    input, select, button{
      font:inherit; border:1px solid var(--line); border-radius:12px; padding:10px 12px; background:#fff;
    }
    input[type="time"], input[type="date"]{padding:9px 10px}
    button{cursor:pointer;font-weight:900}
    .btn{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:#fff;color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .mini{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;background:#fafafa}
    .spacer{flex:1}
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:900;background:#fafafa}
    tr:last-child td{border-bottom:0}
    .nowrap{white-space:nowrap}
    .done{text-decoration:line-through;color:var(--muted)}
    .warn{color:#b45309}
    .ok{color:#047857}
    .err{color:#b91c1c}
    .topNote{margin:10px 4px 0}
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace;background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ« & ToDoï¼ˆè¡¨ï¼‰ + é”æˆç‡</h1>
    <div class="tabs" role="tablist" aria-label="view">
      <button class="tab active" data-view="day">æ—¥</button>
      <button class="tab" data-view="week">é€±</button>
      <button class="tab" data-view="month">æœˆ</button>
    </div>
  </header>

  <p class="mini topNote">
    ä¿å­˜å…ˆï¼šSupabaseï¼ˆã‚¹ãƒãƒ›/PCåŒæœŸï¼‰ / è¡¨ç¤ºï¼šæ—¥ãƒ»é€±ãƒ»æœˆã§åˆ‡ã‚Šæ›¿ãˆ
  </p>

  <div class="grid">
    <!-- Schedule -->
    <section class="card">
      <h2 id="scheduleTitle">ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆæ—¥ï¼‰</h2>
      <div class="body">
        <div class="row">
          <div>
            <div class="mini">æ—¥ä»˜</div>
            <input id="schDate" type="date">
          </div>
          <div>
            <div class="mini">æ™‚é–“</div>
            <input id="schTime" type="time">
          </div>
          <div style="flex:1;min-width:240px">
            <div class="mini">å†…å®¹</div>
            <input id="schText" placeholder="ä¾‹ï¼šè‹±å˜èª 30åˆ† / é¢æ¥ç·´ç¿’ / K.ARTS ä»•è¾¼ã¿" />
          </div>
          <button class="btn" id="addSchedule">è¿½åŠ </button>
        </div>

        <div class="row" style="margin:12px 0 0; align-items:center">
          <span class="pill">è¡¨ç¤ºç¯„å›²ï¼š<b id="rangeLabel">ä»Šæ—¥</b></span>
          <span class="spacer"></span>
          <button class="btn ghost" id="refreshAll">æ›´æ–°</button>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th class="nowrap">æ—¥ä»˜</th>
                <th class="nowrap">æ™‚é–“</th>
                <th>å†…å®¹</th>
                <th class="nowrap">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="scheduleBody"></tbody>
          </table>
        </div>

        <p class="mini" id="statusLine"></p>
      </div>
    </section>

    <!-- Todo + Chart -->
    <section class="card">
      <h2 id="todoTitle">ToDoï¼ˆæ—¥ï¼‰</h2>
      <div class="body">
        <div class="row">
          <div style="flex:1;min-width:240px">
            <div class="mini">ToDo</div>
            <input id="todoText" placeholder="ä¾‹ï¼šæ•°å­¦ 10å• / GitHubã«push / ç¼¶ã‚±ãƒ¼ã‚¹è©°ã‚ã‚‹" />
          </div>
          <div>
            <div class="mini">äºˆå®šæ—¥</div>
            <input id="todoDate" type="date">
          </div>
          <button class="btn" id="addTodo">è¿½åŠ </button>
        </div>

        <div class="row" style="margin:12px 0 0; align-items:center">
          <span class="pill">ã“ã®ç¯„å›²ã®ToDo</span>
          <span class="spacer"></span>
          <button class="btn ghost" id="markAllDone">ä»Šæ—¥(ç¯„å›²)ã‚’å…¨éƒ¨å®Œäº†</button>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th class="nowrap">å®Œäº†</th>
                <th>å†…å®¹</th>
                <th class="nowrap">äºˆå®šæ—¥</th>
                <th class="nowrap">æ“ä½œ</th>
              </tr>
            </thead>
            <tbody id="todoBody"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>é”æˆç‡ï¼ˆæ—¥/é€±/æœˆï¼‰</h2>
          <div class="body">
            <canvas id="rateChart" height="120"></canvas>
            <p class="mini">ç¯„å›²å†…ToDoã®ã€Œå®Œäº†æ•° / ç·æ•°ã€ã‹ã‚‰é”æˆç‡(%)ã‚’è¨ˆç®—</p>
          </div>
        </div>

        <p class="mini warn">
          ğŸ”ã€Œæœªå®Œäº†ToDoã‚’ç¿Œæ—¥ã«è‡ªå‹•ç”Ÿæˆã€ã¯ <span class="kbd">DBå´cron</span> ã§ã‚„ã‚‹ã®ãŒå®‰å…¨ï¼ˆã‚ã¨ã§SQLæ¸¡ã™ï¼‰
        </p>
      </div>
    </section>
  </div>
</div>

<!-- libs -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  // ===== Supabase (ã‚ãªãŸã®å€¤) =====
  const supabaseUrl = "https://qzobchxakdvubfkdwxxf.supabase.co";
  const supabaseKey = "sb_publishable_L39SGNHMqWijT5_cX3BwDA_J5JWnrPA";
  const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

  // ===== state =====
  let view = "day"; // day | week | month
  let rateChart = null;

  // ===== dom =====
  const tabs = [...document.querySelectorAll(".tab")];
  const scheduleTitle = document.getElementById("scheduleTitle");
  const todoTitle = document.getElementById("todoTitle");
  const rangeLabel = document.getElementById("rangeLabel");
  const statusLine = document.getElementById("statusLine");

  const schDate = document.getElementById("schDate");
  const schTime = document.getElementById("schTime");
  const schText = document.getElementById("schText");
  const addScheduleBtn = document.getElementById("addSchedule");
  const scheduleBody = document.getElementById("scheduleBody");

  const todoText = document.getElementById("todoText");
  const todoDate = document.getElementById("todoDate");
  const addTodoBtn = document.getElementById("addTodo");
  const todoBody = document.getElementById("todoBody");

  const refreshAllBtn = document.getElementById("refreshAll");
  const markAllDoneBtn = document.getElementById("markAllDone");

  // ===== utils =====
  const pad = (n) => String(n).padStart(2,"0");
  const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;

  function todayStr() { return ymd(new Date()); }

  function startOfWeek(date) { // Monday start
    const d = new Date(date);
    const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
    d.setDate(d.getDate() - day);
    d.setHours(0,0,0,0);
    return d;
  }
  function endOfWeek(date) {
    const s = startOfWeek(date);
    const e = new Date(s);
    e.setDate(e.getDate() + 6);
    e.setHours(23,59,59,999);
    return e;
  }
  function startOfMonth(date) {
    const d = new Date(date);
    d.setDate(1); d.setHours(0,0,0,0);
    return d;
  }
  function endOfMonth(date) {
    const d = new Date(date);
    d.setMonth(d.getMonth()+1, 0);
    d.setHours(23,59,59,999);
    return d;
  }

  function currentRange() {
    const now = new Date();
    if (view === "day") {
      const a = new Date(now); a.setHours(0,0,0,0);
      const b = new Date(now); b.setHours(23,59,59,999);
      return { a, b, label: "ä»Šæ—¥" };
    }
    if (view === "week") {
      const a = startOfWeek(now);
      const b = endOfWeek(now);
      const label = `${a.getFullYear()}/${pad(a.getMonth()+1)}/${pad(a.getDate())} - ${b.getFullYear()}/${pad(b.getMonth()+1)}/${pad(b.getDate())}`;
      return { a, b, label: `ä»Šé€±ï¼ˆ${label}ï¼‰` };
    }
    const a = startOfMonth(now);
    const b = endOfMonth(now);
    return { a, b, label: `ä»Šæœˆï¼ˆ${a.getFullYear()}/${pad(a.getMonth()+1)}ï¼‰` };
  }

  function setTitles() {
    const jp = view === "day" ? "æ—¥" : view === "week" ? "é€±" : "æœˆ";
    scheduleTitle.textContent = `ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ï¼ˆ${jp}ï¼‰`;
    todoTitle.textContent = `ToDoï¼ˆ${jp}ï¼‰`;
    rangeLabel.textContent = currentRange().label;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setStatus(msg, type="") {
    const cls = type === "ok" ? "ok" : type === "err" ? "err" : type === "warn" ? "warn" : "";
    statusLine.className = `mini ${cls}`;
    statusLine.textContent = msg || "";
  }

  // ===== Supabase queries =====
  async function insertSchedule(date, time, text) {
    const { error } = await supabase.from("schedules").insert({ date, time: time || null, text });
    if (error) throw error;
  }

  async function deleteSchedule(id) {
    const { error } = await supabase.from("schedules").delete().eq("id", id);
    if (error) throw error;
  }

  async function fetchSchedules(fromYmd, toYmd) {
    const { data, error } = await supabase
      .from("schedules")
      .select("id, date, time, text")
      .gte("date", fromYmd)
      .lte("date", toYmd)
      .order("date", { ascending: true })
      .order("time", { ascending: true });

    if (error) throw error;
    return data ?? [];
  }

  async function insertTodo(text, planned_date) {
    const { error } = await supabase.from("todos").insert({
      text,
      planned_date,
      done: false,
      completed_at: null
    });
    if (error) throw error;
  }

  async function deleteTodo(id) {
    const { error } = await supabase.from("todos").delete().eq("id", id);
    if (error) throw error;
  }

  async function toggleTodo(id, done) {
    const payload = done
      ? { done: true, completed_at: new Date().toISOString() }
      : { done: false, completed_at: null };

    const { error } = await supabase.from("todos").update(payload).eq("id", id);
    if (error) throw error;
  }

  async function fetchTodos(fromYmd, toYmd) {
    const { data, error } = await supabase
      .from("todos")
      .select("id, text, planned_date, done")
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd)
      .order("done", { ascending: true })
      .order("planned_date", { ascending: true })
      .order("created_at", { ascending: true });

    if (error) throw error;
    return data ?? [];
  }

  async function markAllDoneInRange(fromYmd, toYmd) {
    // ç¯„å›²å†…ã§æœªå®Œäº†ã®è¡Œã ã‘ true ã«ã™ã‚‹
    const { error } = await supabase
      .from("todos")
      .update({ done: true, completed_at: new Date().toISOString() })
      .eq("done", false)
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd);

    if (error) throw error;
  }

  // ===== render =====
  async function renderSchedules() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);

    const rows = await fetchSchedules(fromYmd, toYmd);

    scheduleBody.innerHTML = rows.map(x => `
      <tr>
        <td class="nowrap">${escapeHtml(x.date)}</td>
        <td class="nowrap">${x.time ? escapeHtml(String(x.time).slice(0,5)) : ""}</td>
        <td>${escapeHtml(x.text)}</td>
        <td class="nowrap">
          <button class="btn danger" data-del-sch="${x.id}">å‰Šé™¤</button>
        </td>
      </tr>
    `).join("") || `
      <tr><td colspan="4" class="mini">ï¼ˆã“ã®ç¯„å›²ã®ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</td></tr>
    `;

    scheduleBody.querySelectorAll("[data-del-sch]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-sch");
        try{
          await deleteSchedule(id);
          await renderAll();
          setStatus("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "ok");
        }catch(e){
          setStatus(`å‰Šé™¤å¤±æ•—ï¼š${e.message}`, "err");
        }
      });
    });
  }

  async function renderTodos() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);

    const rows = await fetchTodos(fromYmd, toYmd);

    todoBody.innerHTML = rows.map(t => `
      <tr>
        <td class="nowrap">
          <input type="checkbox" data-todo-check="${t.id}" ${t.done ? "checked":""}>
        </td>
        <td class="${t.done ? "done":""}">${escapeHtml(t.text)}</td>
        <td class="nowrap">${escapeHtml(t.planned_date)}</td>
        <td class="nowrap">
          <button class="btn danger" data-del-todo="${t.id}">å‰Šé™¤</button>
        </td>
      </tr>
    `).join("") || `
      <tr><td colspan="4" class="mini">ï¼ˆã“ã®ç¯„å›²ã®ToDoã¯ã¾ã ã‚ã‚Šã¾ã›ã‚“ï¼‰</td></tr>
    `;

    // checkbox toggle
    todoBody.querySelectorAll("[data-todo-check]").forEach(ch=>{
      ch.addEventListener("change", async () => {
        const id = ch.getAttribute("data-todo-check");
        try{
          await toggleTodo(id, ch.checked);
          await renderAll();
          setStatus(ch.checked ? "å®Œäº†ã«ã—ã¾ã—ãŸ" : "æœªå®Œäº†ã«æˆ»ã—ã¾ã—ãŸ", "ok");
        }catch(e){
          setStatus(`æ›´æ–°å¤±æ•—ï¼š${e.message}`, "err");
        }
      });
    });

    // delete
    todoBody.querySelectorAll("[data-del-todo]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        const id = btn.getAttribute("data-del-todo");
        try{
          await deleteTodo(id);
          await renderAll();
          setStatus("ToDoã‚’å‰Šé™¤ã—ã¾ã—ãŸ", "ok");
        }catch(e){
          setStatus(`å‰Šé™¤å¤±æ•—ï¼š${e.message}`, "err");
        }
      });
    });
  }

  async function renderRateChartForView() {
    const { a, b, label } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);

    const todos = await fetchTodos(fromYmd, toYmd);
    const total = todos.length;
    const done = todos.filter(t => t.done).length;
    const rate = total ? Math.round(done / total * 100) : 0;

    if (rateChart) rateChart.destroy();
    rateChart = new Chart(document.getElementById("rateChart"), {
      type: "bar",
      data: {
        labels: [label],
        datasets: [{ label: "é”æˆç‡(%)", data: [rate] }]
      },
      options: {
        scales: { y: { beginAtZero: true, max: 100 } }
      }
    });
  }

  async function renderAll() {
    setTitles();
    setStatus("åŒæœŸä¸­â€¦", "warn");
    try{
      await renderSchedules();
      await renderTodos();
      await renderRateChartForView();
      setStatus("åŒæœŸOK", "ok");
    }catch(e){
      setStatus(`ã‚¨ãƒ©ãƒ¼ï¼š${e.message}`, "err");
    }
  }

  // ===== init =====
  schDate.value = todayStr();
  todoDate.value = todayStr();

  // tabs
  tabs.forEach(t=>{
    t.addEventListener("click", async ()=>{
      view = t.dataset.view;
      tabs.forEach(x=>x.classList.toggle("active", x===t));
      await renderAll();
    });
  });

  // add schedule
  addScheduleBtn.addEventListener("click", async ()=>{
    const date = schDate.value || todayStr();
    const time = schTime.value || "";
    const text = (schText.value || "").trim();
    if(!text) return alert("å†…å®¹ã‚’å…¥ã‚Œã¦ã­");

    try{
      await insertSchedule(date, time, text);
      schText.value = "";
      await renderAll();
      setStatus("ã‚¹ã‚±ã‚¸ãƒ¥ãƒ¼ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ", "ok");
    }catch(e){
      setStatus(`è¿½åŠ å¤±æ•—ï¼š${e.message}`, "err");
    }
  });

  // add todo
  addTodoBtn.addEventListener("click", async ()=>{
    const text = (todoText.value || "").trim();
    const planned = todoDate.value || todayStr();
    if(!text) return alert("ToDoã‚’å…¥ã‚Œã¦ã­");

    try{
      await insertTodo(text, planned);
      todoText.value = "";
      await renderAll();
      setStatus("ToDoã‚’è¿½åŠ ã—ã¾ã—ãŸ", "ok");
    }catch(e){
      setStatus(`è¿½åŠ å¤±æ•—ï¼š${e.message}`, "err");
    }
  });

  // refresh
  refreshAllBtn.addEventListener("click", async ()=>{
    await renderAll();
  });

  // mark all done
  markAllDoneBtn.addEventListener("click", async ()=>{
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    if(!confirm("ã“ã®ç¯„å›²ã®ToDoã‚’å…¨éƒ¨å®Œäº†ã«ã™ã‚‹ï¼Ÿ")) return;

    try{
      await markAllDoneInRange(fromYmd, toYmd);
      await renderAll();
      setStatus("ç¯„å›²å†…ToDoã‚’å…¨éƒ¨å®Œäº†ã«ã—ã¾ã—ãŸ", "ok");
    }catch(e){
      setStatus(`ä¸€æ‹¬å®Œäº†å¤±æ•—ï¼š${e.message}`, "err");
    }
  });

  // first render
  renderAll();
</script>
</body>
</html>

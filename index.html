<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>スケジュール & ToDo（日/週/月）+ 達成率</title>
  <style>
    :root{
      --bg:#f6f7fb; --card:#fff; --text:#111827; --muted:#6b7280; --line:#e5e7eb;
      --accent:#2563eb; --ok:#10b981; --danger:#ef4444; --shadow:0 10px 30px rgba(0,0,0,.08);
      --r:16px; --chip:#eef2ff;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,"Segoe UI",sans-serif;background:var(--bg);color:var(--text)}
    .wrap{max-width:1150px;margin:24px auto;padding:0 14px}
    header{display:flex;gap:12px;align-items:center;justify-content:space-between;flex-wrap:wrap}
    h1{font-size:18px;margin:0}
    .tabs{display:flex;gap:8px;background:var(--chip);padding:6px;border-radius:999px}
    .tab{border:0;background:transparent;padding:8px 12px;border-radius:999px;cursor:pointer;color:var(--muted);font-weight:800}
    .tab.active{background:var(--card);color:var(--text);box-shadow:0 6px 16px rgba(0,0,0,.08)}
    .grid{display:grid;grid-template-columns:1fr;gap:14px;margin-top:14px}
    @media(min-width:980px){.grid{grid-template-columns:1.2fr .8fr}}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);overflow:hidden}
    .card h2{font-size:14px;margin:0;padding:12px 14px;border-bottom:1px solid var(--line);color:var(--muted)}
    .card .body{padding:12px 14px}
    .row{display:flex;gap:10px;flex-wrap:wrap;align-items:end}
    input, button{font:inherit;border:1px solid var(--line);border-radius:12px;padding:10px 12px;background:#fff}
    input[type="time"], input[type="date"]{padding:9px 10px}
    button{cursor:pointer;font-weight:900}
    .btn{background:var(--accent);color:#fff;border-color:transparent}
    .btn.ghost{background:#fff;color:var(--text)}
    .btn.danger{background:var(--danger);color:#fff;border-color:transparent}
    .btn.ok{background:var(--ok);color:#fff;border-color:transparent}
    .mini{font-size:12px;color:var(--muted)}
    .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 10px;border-radius:999px;border:1px solid var(--line);color:var(--muted);font-size:12px;background:#fafafa}
    .spacer{flex:1}
    .nowrap{white-space:nowrap}
    .done{text-decoration:line-through;color:var(--muted)}
    .okText{color:#047857}
    .warnText{color:#b45309}
    .errText{color:#b91c1c}
    .fatal{margin:14px 0;padding:12px 14px;border:1px solid #fecaca;background:#fff1f2;border-radius:12px;display:none}
    .fatal b{display:block;margin-bottom:6px}
    code{background:#f3f4f6;border:1px solid #e5e7eb;padding:2px 6px;border-radius:8px}

    /* ===== スケジュール表示 ===== */
    #scheduleView{margin-top:10px}
    .sv-card{background:#fff;border:1px solid var(--line);border-radius:14px;padding:10px 12px}
    .sv-title{font-weight:900}
    .sv-sub{font-size:12px;color:var(--muted);margin-top:4px;display:flex;gap:10px;flex-wrap:wrap;align-items:center}
    .sv-actions{margin-left:auto;display:flex;gap:8px}
    .sv-actions button{padding:6px 10px;border-radius:10px}

    /* 日：タイムライン */
    .timeline{position:relative;padding-left:62px}
    .timeline.hide-now .tline-now{display:none}
    .tline-now{position:absolute;left:0;right:0;height:0;border-top:2px dashed #60a5fa;opacity:.75}
    .tline-hour{position:relative;height:44px;border-left:2px solid var(--line)}
    .tline-hour .lab{position:absolute;left:-62px;top:-8px;width:54px;text-align:right;font-size:12px;color:var(--muted)}
    .tline-item{position:absolute;left:10px;right:auto}
    .tline-item .sv-card{box-shadow:0 8px 18px rgba(0,0,0,.05);min-height:38px}

    /* 週：曜日×時間 */
    .weekgrid{display:grid;grid-template-columns:56px repeat(7,1fr);border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .wg-head{background:#f3f4f6;font-size:12px;padding:10px;border-bottom:1px solid var(--line)}
    .wg-time{background:#fafafa;font-size:12px;padding:10px;border-right:1px solid var(--line);border-bottom:1px solid var(--line)}
    .wg-cell{min-height:54px;padding:6px;border-bottom:1px solid var(--line);border-right:1px solid var(--line)}
    .wg-badge{display:block;font-size:12px;background:#eff6ff;padding:6px 8px;border-radius:10px;margin-bottom:6px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

    /* 月：カレンダー */
    .monthHeader{display:flex;align-items:center;gap:10px}
    .monthHeader .mBtn{padding:8px 10px;border-radius:12px}
    .month{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
    .mday{border:1px solid var(--line);border-radius:14px;min-height:104px;padding:8px;background:#fff;cursor:pointer}
    .mday .num{font-weight:900}
    .mday .dots{margin-top:6px;display:flex;gap:4px;flex-wrap:wrap}
    .dot{width:8px;height:8px;border-radius:999px;background:#93c5fd}      /* schedule */
    .dot.todo{background:#86efac}                                        /* todo */
    .mday.off{opacity:.35}
    .mday.today{outline:3px solid #bfdbfe}
    .legend{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .legend .item{display:flex;gap:6px;align-items:center;font-size:12px;color:var(--muted)}
    .legend .sw{width:10px;height:10px;border-radius:999px;background:#93c5fd;border:1px solid var(--line)}
    .legend .sw.todo{background:#86efac}

    /* ToDo */
    table{width:100%;border-collapse:collapse}
    th,td{padding:10px 10px;border-bottom:1px solid var(--line);text-align:left;font-size:13px;vertical-align:top}
    th{color:var(--muted);font-weight:900;background:#fafafa}
    tr:last-child td{border-bottom:0}
    .todo-tools{display:flex;gap:8px;flex-wrap:wrap}
  </style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>スケジュール & ToDo + 達成率</h1>
    <div class="tabs" role="tablist" aria-label="view">
      <button class="tab active" data-view="day">日</button>
      <button class="tab" data-view="week">週</button>
      <button class="tab" data-view="month">月</button>
    </div>
  </header>

  <div id="fatal" class="fatal">
    <b>エラーで止まっています</b>
    <div class="mini" id="fatalMsg"></div>
    <div class="mini" style="margin-top:8px">※ DevTools → Console の赤い行も貼ってOK</div>
  </div>

  <p class="mini" style="margin:10px 4px 0">
    保存先：Supabase（ログイン無し） / 表示：日・週・月で切り替え
  </p>

  <div class="grid">
    <!-- Schedule -->
    <section class="card">
      <h2 id="scheduleTitle">スケジュール（日）</h2>
      <div class="body">
        <div class="row">
          <div>
            <div class="mini">日付</div>
            <input id="schDate" type="date">
          </div>
          <div>
            <div class="mini">時間</div>
            <input id="schTime" type="time">
          </div>
          <div style="flex:1;min-width:240px">
            <div class="mini">内容</div>
            <input id="schText" placeholder="例：英単語 30分 / 面接練習 / K.ARTS" />
          </div>
          <button class="btn" id="addSchedule">追加</button>
        </div>

        <div class="row" style="margin:12px 0 0; align-items:center">
          <span class="pill">表示範囲：<b id="rangeLabel">今日</b></span>
          <span class="spacer"></span>
          <button class="btn ghost" id="toggleNowLine">Now線: ON</button>
          <button class="btn ghost" id="refreshAll">更新</button>
        </div>

        <div id="scheduleView"></div>
        <p class="mini" id="statusLine"></p>
      </div>
    </section>

    <!-- Todo + Chart -->
    <section class="card">
      <h2 id="todoTitle">ToDo（日）</h2>
      <div class="body">
        <div class="row">
          <div style="flex:1;min-width:240px">
            <div class="mini">ToDo</div>
            <input id="todoText" placeholder="例：数学 10問 / GitHubにpush" />
          </div>
          <div>
            <div class="mini">予定日</div>
            <input id="todoDate" type="date">
          </div>
          <button class="btn" id="addTodo">追加</button>
        </div>

        <div class="row" style="margin:12px 0 0; align-items:center">
          <span class="pill">この範囲のToDo</span>
          <span class="spacer"></span>

          <div class="todo-tools">
            <button class="btn ghost" id="markAllDone">今日(範囲)を全部完了</button>
            <button class="btn ok" id="carryOverNext">未完了を明日に持ち越し</button>
            <button class="btn ghost" id="collectOverdue">期限切れ(過去)を今日へ集約</button>
          </div>
        </div>

        <div style="margin-top:10px;overflow:auto">
          <table>
            <thead>
              <tr>
                <th class="nowrap">完了</th>
                <th>内容</th>
                <th class="nowrap">予定日</th>
                <th class="nowrap">操作</th>
              </tr>
            </thead>
            <tbody id="todoBody"></tbody>
          </table>
        </div>

        <div class="card" style="margin-top:14px">
          <h2>達成率（日/週/月）</h2>
          <div class="body">
            <canvas id="rateChart" height="120"></canvas>
            <p class="mini">範囲内ToDoの「完了数 / 総数」から達成率(%)を計算</p>
          </div>
        </div>
      </div>
    </section>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  // ===== 画面上に致命的エラー表示（白紙対策） =====
  function showFatal(err){
    console.error(err);
    const box = document.getElementById("fatal");
    const msg = document.getElementById("fatalMsg");
    box.style.display = "block";
    msg.innerHTML = `原因：<code>${String(err?.message || err)}</code>`;
  }
  window.addEventListener("error", (e)=>showFatal(e.error || e.message));
  window.addEventListener("unhandledrejection", (e)=>showFatal(e.reason || e));

  // ===== Supabase =====
  const SUPABASE_URL = "https://vxtrnewebvqdgnknktdt.supabase.co";
  const SUPABASE_ANON =
    "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZ4dHJuZXdlYnZxZGdua25rdGR0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjYyNDM0MDIsImV4cCI6MjA4MTgxOTQwMn0.1MtxmKyLVSp_LfyfE3jXn8TBKRf0G6WdMFLxUrM_TsM";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON);

  // ===== state =====
  let view = "day"; // day | week | month
  let rateChart = null;
  let monthCursor = new Date(); // 表示中の月

  // now線 表示ON/OFF
  const NOW_KEY = "showNowLine";
  let showNowLine = (localStorage.getItem(NOW_KEY) ?? "1") === "1";

  // ===== dom =====
  const tabs = [...document.querySelectorAll(".tab")];
  const scheduleTitle = document.getElementById("scheduleTitle");
  const todoTitle = document.getElementById("todoTitle");
  const rangeLabel = document.getElementById("rangeLabel");
  const statusLine = document.getElementById("statusLine");
  const scheduleView = document.getElementById("scheduleView");

  const schDate = document.getElementById("schDate");
  const schTime = document.getElementById("schTime");
  const schText = document.getElementById("schText");
  const addScheduleBtn = document.getElementById("addSchedule");

  const todoText = document.getElementById("todoText");
  const todoDate = document.getElementById("todoDate");
  const addTodoBtn = document.getElementById("addTodo");
  const todoBody = document.getElementById("todoBody");

  const refreshAllBtn = document.getElementById("refreshAll");
  const toggleNowLineBtn = document.getElementById("toggleNowLine");
  const markAllDoneBtn = document.getElementById("markAllDone");
  const carryOverNextBtn = document.getElementById("carryOverNext");
  const collectOverdueBtn = document.getElementById("collectOverdue");

  // ===== utils =====
  const pad = (n) => String(n).padStart(2,"0");
  const ymd = (d) => `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
  const todayStr = () => ymd(new Date());

  function addDays(date, n){
    const d = new Date(date);
    d.setDate(d.getDate() + n);
    return d;
  }

  function startOfWeek(date) { // Monday start
    const d = new Date(date);
    const day = (d.getDay() + 6) % 7; // Mon=0..Sun=6
    d.setDate(d.getDate() - day);
    d.setHours(0,0,0,0);
    return d;
  }
  function endOfWeek(date) {
    const s = startOfWeek(date);
    const e = new Date(s);
    e.setDate(e.getDate() + 6);
    e.setHours(23,59,59,999);
    return e;
  }
  function startOfMonth(date) {
    const d = new Date(date);
    d.setDate(1); d.setHours(0,0,0,0);
    return d;
  }
  function endOfMonth(date) {
    const d = new Date(date);
    d.setMonth(d.getMonth()+1, 0);
    d.setHours(23,59,59,999);
    return d;
  }

  function currentRange() {
    if (view === "day") {
      const base = new Date((schDate.value || todayStr()) + "T00:00:00");
      const a = new Date(base); a.setHours(0,0,0,0);
      const b = new Date(base); b.setHours(23,59,59,999);
      const label = (!schDate.value || schDate.value === todayStr())
        ? "今日"
        : `${a.getFullYear()}/${pad(a.getMonth()+1)}/${pad(a.getDate())}`;
      return { a, b, label };
    }
    if (view === "week") {
      const now = new Date();
      const a = startOfWeek(now);
      const b = endOfWeek(now);
      const label = `${a.getFullYear()}/${pad(a.getMonth()+1)}/${pad(a.getDate())} - ${b.getFullYear()}/${pad(b.getMonth()+1)}/${pad(b.getDate())}`;
      return { a, b, label: `今週（${label}）` };
    }
    const a = startOfMonth(monthCursor);
    const b = endOfMonth(monthCursor);
    return { a, b, label: `今月（${a.getFullYear()}/${pad(a.getMonth()+1)}）` };
  }

  function setTitles() {
    const jp = view === "day" ? "日" : view === "week" ? "週" : "月";
    scheduleTitle.textContent = `スケジュール（${jp}）`;
    todoTitle.textContent = `ToDo（${jp}）`;
    rangeLabel.textContent = currentRange().label;
  }

  function escapeHtml(s){
    return String(s)
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function setStatus(msg, type="") {
    const cls = type === "ok" ? "okText" : type === "err" ? "errText" : type === "warn" ? "warnText" : "";
    statusLine.className = `mini ${cls}`;
    statusLine.textContent = msg || "";
  }

  function parseHHMM(t){
    if(!t) return null;
    const s = String(t).slice(0,5);
    const [h,m]=s.split(":").map(Number);
    if(Number.isNaN(h)||Number.isNaN(m)) return null;
    return h*60+m;
  }

  // ===== Supabase queries =====
  async function insertSchedule(date, time, text) {
    const { error } = await sb.from("schedules").insert({ date, time: time || null, text });
    if (error) throw error;
  }
  async function deleteSchedule(id) {
    const { error } = await sb.from("schedules").delete().eq("id", id);
    if (error) throw error;
  }
  async function fetchSchedules(fromYmd, toYmd) {
    const { data, error } = await sb
      .from("schedules")
      .select("id, date, time, text")
      .gte("date", fromYmd)
      .lte("date", toYmd)
      .order("date", { ascending: true })
      .order("time", { ascending: true });
    if (error) throw error;
    return data ?? [];
  }

  async function insertTodo(text, planned_date) {
    const { error } = await sb.from("todos").insert({
      text, planned_date, done:false, completed_at:null
    });
    if (error) throw error;
  }
  async function deleteTodo(id) {
    const { error } = await sb.from("todos").delete().eq("id", id);
    if (error) throw error;
  }
  async function toggleTodo(id, done) {
    const payload = done
      ? { done: true, completed_at: new Date().toISOString() }
      : { done: false, completed_at: null };
    const { error } = await sb.from("todos").update(payload).eq("id", id);
    if (error) throw error;
  }
  async function fetchTodos(fromYmd, toYmd) {
    const { data, error } = await sb
      .from("todos")
      .select("id, text, planned_date, done, created_at")
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd)
      .order("done", { ascending: true })
      .order("planned_date", { ascending: true })
      .order("created_at", { ascending: true });
    if (error) throw error;
    return data ?? [];
  }
  async function markAllDoneInRange(fromYmd, toYmd) {
    const { error } = await sb
      .from("todos")
      .update({ done: true, completed_at: new Date().toISOString() })
      .eq("done", false)
      .gte("planned_date", fromYmd)
      .lte("planned_date", toYmd);
    if (error) throw error;
  }

  async function carryOverUndoneToNextDay(fromYmd, toYmd){
    const rows = await fetchTodos(fromYmd, toYmd);
    const undone = rows.filter(r => !r.done);
    if(!undone.length) return 0;

    const base = new Date(toYmd + "T00:00:00");
    const next = addDays(base, 1);
    const nextYmd = ymd(next);

    const ids = undone.map(x => x.id);
    const { error } = await sb.from("todos").update({ planned_date: nextYmd }).in("id", ids);
    if(error) throw error;
    return undone.length;
  }

  async function collectOverdueToToday(){
    const today = todayStr();
    const { data, error } = await sb
      .from("todos")
      .select("id, planned_date, done")
      .lt("planned_date", today)
      .eq("done", false);
    if(error) throw error;

    const ids = (data ?? []).map(x => x.id);
    if(!ids.length) return 0;

    const { error: e2 } = await sb.from("todos").update({ planned_date: today }).in("id", ids);
    if(e2) throw e2;
    return ids.length;
  }

  // ===== スケジュール描画（3ビュー） =====
  function renderScheduleDayTimeline(rows){
    scheduleView.innerHTML = "";

    const dayKey = schDate.value || todayStr();
    const dayRows = rows.filter(r => r.date === dayKey);

    const withTime = dayRows.filter(r => !!r.time).slice();
    const noTime = dayRows.filter(r => !r.time).slice();
    withTime.sort((a,b)=> (a.time||"99:99").localeCompare(b.time||"99:99"));

    const container = document.createElement("div");
    container.className = "timeline";
    if(!showNowLine) container.classList.add("hide-now");

    const startMin = 6*60;
    const endMin = 24*60;
    const totalMin = endMin - startMin;
    const pxPerMin = (44*18) / totalMin;

    // 目盛
    for(let h=6; h<=24; h++){
      const hour = document.createElement("div");
      hour.className = "tline-hour";
      const lab = document.createElement("div");
      lab.className = "lab";
      lab.textContent = String(h).padStart(2,"0")+":00";
      hour.appendChild(lab);
      container.appendChild(hour);
    }

    // Nowライン：今日のときだけ
    const isTodayView = (dayKey === todayStr());
    if(isTodayView){
      const now = new Date();
      const nowMin = now.getHours()*60 + now.getMinutes();
      if(nowMin >= startMin && nowMin <= endMin){
        const nowLine = document.createElement("div");
        nowLine.className = "tline-now";
        nowLine.style.top = `${(nowMin - startMin) * pxPerMin}px`;
        container.appendChild(nowLine);
      }
    }

    // ===== 被り解消：レーン分け =====
    const BLOCK_MIN = 30; // 被り判定用（30分枠）
    const items = withTime
      .map(r=>{
        const m = parseHHMM(r.time);
        return { ...r, startMin: m, endMin: m===null ? null : Math.min(endMin, m + BLOCK_MIN) };
      })
      .filter(x=>x.startMin!==null && x.startMin>=startMin && x.startMin<=endMin);

    // 重なりグループ
    const groups = [];
    for(const it of items){
      let placed = false;
      for(const g of groups){
        const overlaps = g.some(x => !(it.endMin <= x.startMin || it.startMin >= x.endMin));
        if(overlaps){ g.push(it); placed = true; break; }
      }
      if(!placed) groups.push([it]);
    }

    // レーン割り当て（貪欲）
    for(const g of groups){
      g.sort((a,b)=>a.startMin-b.startMin);
      const lanesEnd = [];
      for(const it of g){
        let lane = -1;
        for(let i=0;i<lanesEnd.length;i++){
          if(it.startMin >= lanesEnd[i]){ lane = i; break; }
        }
        if(lane === -1){
          lane = lanesEnd.length;
          lanesEnd.push(it.endMin);
        }else{
          lanesEnd[lane] = it.endMin;
        }
        it._lane = lane;
        it._laneCount = null;
      }
      const laneCount = lanesEnd.length;
      for(const it of g) it._laneCount = laneCount;
    }

    // 描画
    for(const r of items){
      const y = (r.startMin - startMin) * pxPerMin;
      const item = document.createElement("div");
      item.className = "tline-item";
      item.style.top = `${Math.max(0, y)}px`;

      const lanes = r._laneCount || 1;
      const lane = r._lane || 0;

      const gap = 8; // %
      const full = 100;
      const w = (full - gap*(lanes-1)) / lanes;
      const left = lane * (w + gap);

      item.style.left = `calc(10px + ${left}%)`;
      item.style.width = `calc(${w}% )`;

      item.innerHTML = `
        <div class="sv-card">
          <div class="sv-title">${escapeHtml(String(r.time).slice(0,5))}　${escapeHtml(r.text || "")}</div>
          <div class="sv-sub">
            <span>${escapeHtml(r.date)}</span>
            <span class="spacer"></span>
            <span class="sv-actions">
              <button class="btn danger" data-del-sch="${r.id}">削除</button>
            </span>
          </div>
        </div>
      `;
      container.appendChild(item);
    }

    scheduleView.appendChild(container);

    // 時間なしメモ
    if(noTime.length){
      const box = document.createElement("div");
      box.style.marginTop = "12px";
      box.innerHTML = `<div class="sv-card"><div class="sv-title">時間なしメモ</div></div>`;
      const inner = box.querySelector(".sv-card");
      for(const r of noTime){
        const line = document.createElement("div");
        line.className = "mini";
        line.style.marginTop = "6px";
        line.textContent = `・${r.text}`;

        const del = document.createElement("button");
        del.className = "btn danger";
        del.style.marginLeft = "10px";
        del.style.padding = "6px 10px";
        del.textContent = "削除";
        del.addEventListener("click", async ()=>{
          try{
            await deleteSchedule(r.id);
            await renderAll();
            setStatus("削除しました", "ok");
          }catch(e){
            setStatus(`削除失敗：${e.message}`, "err");
          }
        });

        line.appendChild(del);
        inner.appendChild(line);
      }
      scheduleView.appendChild(box);
    }

    if(!dayRows.length){
      const empty = document.createElement("div");
      empty.className = "sv-card";
      empty.style.marginTop = "10px";
      empty.innerHTML = `<div class="mini">（この日のスケジュールはまだありません）</div>`;
      scheduleView.appendChild(empty);
    }

    // 削除
    scheduleView.querySelectorAll("[data-del-sch]").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        try{
          await deleteSchedule(btn.getAttribute("data-del-sch"));
          await renderAll();
          setStatus("削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  function renderScheduleWeekGrid(rows){
    scheduleView.innerHTML = "";

    const start = startOfWeek(new Date());
    const days = [...Array(7)].map((_,i)=> addDays(start,i));
    const dayKeys = days.map(d=>ymd(d));

    const map = new Map();
    for(const r of rows){
      if(!map.has(r.date)) map.set(r.date, []);
      map.get(r.date).push(r);
    }
    for(const [k, arr] of map){
      arr.sort((a,b)=> (a.time||"99:99").localeCompare(b.time||"99:99"));
    }

    // 6〜24 を1時間刻み
    const hours = [];
    for(let h=6; h<=24; h++) hours.push(h);

    const names = ["月","火","水","木","金","土","日"];
    const grid = document.createElement("div");
    grid.className = "weekgrid";

    grid.appendChild(Object.assign(document.createElement("div"), { className:"wg-head", textContent:"" }));
    for(let i=0;i<7;i++){
      const d = days[i];
      const head = document.createElement("div");
      head.className = "wg-head";
      head.textContent = `${names[i]} ${d.getMonth()+1}/${d.getDate()}`;
      grid.appendChild(head);
    }

    for(const h of hours){
      const tcell = document.createElement("div");
      tcell.className = "wg-time";
      tcell.textContent = `${String(h).padStart(2,"0")}:00`;
      grid.appendChild(tcell);

      for(let i=0;i<7;i++){
        const k = dayKeys[i];
        const cell = document.createElement("div");
        cell.className = "wg-cell";

        const list = (map.get(k)||[]).filter(r=>{
          if(!r.time) return false;
          const m = parseHHMM(r.time);
          return m!==null && m>=h*60 && m<((h+1)*60);
        });

        for(const r of list.slice(0,5)){
          const b = document.createElement("span");
          b.className = "wg-badge";
          b.title = `${String(r.time).slice(0,5)} ${r.text}`;
          b.textContent = `${String(r.time).slice(0,5)} ${r.text}`;
          cell.appendChild(b);
        }
        if(list.length>5){
          const more = document.createElement("div");
          more.className = "mini";
          more.textContent = `+${list.length-5}件`;
          cell.appendChild(more);
        }
        grid.appendChild(cell);
      }
    }

    scheduleView.appendChild(grid);

    const note = document.createElement("div");
    note.className = "mini";
    note.style.marginTop = "10px";
    note.textContent = "※ 週は 6:00〜24:00 を1時間刻みで表示";
    scheduleView.appendChild(note);
  }

  function renderScheduleMonthCalendar(schedules, todos){
    scheduleView.innerHTML = "";

    const a = startOfMonth(monthCursor);
    const y = a.getFullYear();
    const m = a.getMonth();

    const header = document.createElement("div");
    header.className = "monthHeader";
    header.innerHTML = `
      <button class="btn ghost mBtn" id="prevMonth">←</button>
      <div class="sv-card" style="padding:8px 12px"><b>${y}年 ${m+1}月</b></div>
      <button class="btn ghost mBtn" id="nextMonth">→</button>
      <span class="spacer"></span>
      <span class="legend">
        <span class="item"><span class="sw"></span>予定</span>
        <span class="item"><span class="sw todo"></span>ToDo</span>
      </span>
      <span class="pill">クリックで日へ</span>
    `;
    scheduleView.appendChild(header);

    const first = new Date(y, m, 1);
    const startDow = first.getDay(); // 0=Sun
    const start = new Date(y, m, 1 - startDow);

    const schMap = new Map();
    for(const r of schedules){
      if(!schMap.has(r.date)) schMap.set(r.date, []);
      schMap.get(r.date).push(r);
    }
    const todoMap = new Map();
    for(const t of todos){
      if(!todoMap.has(t.planned_date)) todoMap.set(t.planned_date, []);
      todoMap.get(t.planned_date).push(t);
    }

    const cal = document.createElement("div");
    cal.className = "month";

    for(let i=0;i<42;i++){
      const d = addDays(start,i);
      const k = ymd(d);
      const inMonth = d.getMonth() === m;

      const cell = document.createElement("div");
      cell.className = "mday" + (inMonth ? "" : " off") + (k===todayStr() ? " today" : "");

      const schList = schMap.get(k) || [];
      const tdList = todoMap.get(k) || [];

      cell.innerHTML = `<div class="num">${d.getDate()}</div><div class="dots"></div>`;
      const dots = cell.querySelector(".dots");

      // schedule dots
      for(let j=0;j<Math.min(schList.length, 6);j++){
        const dot = document.createElement("span");
        dot.className = "dot";
        dots.appendChild(dot);
      }

      // todo dots
      for(let j=0;j<Math.min(tdList.length, 6);j++){
        const dot = document.createElement("span");
        dot.className = "dot todo";
        dots.appendChild(dot);
      }

      if(schList.length || tdList.length){
        const undone = tdList.filter(x=>!x.done).length;
        const t = document.createElement("div");
        t.className = "mini";
        t.style.marginTop = "6px";
        const parts = [];
        if(schList.length) parts.push(`予定${schList.length}`);
        if(tdList.length) parts.push(`ToDo${tdList.length}（未${undone}）`);
        t.textContent = parts.join(" / ");
        cell.appendChild(t);
      }

      cell.addEventListener("click", ()=>{
        schDate.value = k;
        todoDate.value = k;
        setView("day");
      });

      cal.appendChild(cell);
    }

    scheduleView.appendChild(cal);

    document.getElementById("prevMonth").addEventListener("click", async ()=>{
      monthCursor = new Date(monthCursor.getFullYear(), monthCursor.getMonth()-1, 1);
      await renderAll();
    });
    document.getElementById("nextMonth").addEventListener("click", async ()=>{
      monthCursor = new Date(monthCursor.getFullYear(), monthCursor.getMonth()+1, 1);
      await renderAll();
    });
  }

  async function renderSchedules() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchSchedules(fromYmd, toYmd);

    if(view === "day") renderScheduleDayTimeline(rows);
    else if(view === "week") renderScheduleWeekGrid(rows);
    else renderScheduleMonthCalendar(rows, []);
  }

  // ===== ToDo render =====
  async function renderTodos() {
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    const rows = await fetchTodos(fromYmd, toYmd);

    todoBody.innerHTML = rows.map(t => `
      <tr>
        <td class="nowrap">
          <input type="checkbox" data-todo-check="${t.id}" ${t.done ? "checked":""}>
        </td>
        <td class="${t.done ? "done":""}">${escapeHtml(t.text)}</td>
        <td class="nowrap">${escapeHtml(t.planned_date)}</td>
        <td class="nowrap">
          <button class="btn danger" data-del-todo="${t.id}">削除</button>
        </td>
      </tr>
    `).join("") || `
      <tr><td colspan="4" class="mini">（この範囲のToDoはまだありません）</td></tr>
    `;

    todoBody.querySelectorAll("[data-todo-check]").forEach(ch=>{
      ch.addEventListener("change", async () => {
        try{
          await toggleTodo(ch.getAttribute("data-todo-check"), ch.checked);
          await renderAll();
          setStatus(ch.checked ? "完了にしました" : "未完了に戻しました", "ok");
        }catch(e){
          setStatus(`更新失敗：${e.message}`, "err");
        }
      });
    });

    todoBody.querySelectorAll("[data-del-todo]").forEach(btn=>{
      btn.addEventListener("click", async () => {
        try{
          await deleteTodo(btn.getAttribute("data-del-todo"));
          await renderAll();
          setStatus("ToDoを削除しました", "ok");
        }catch(e){
          setStatus(`削除失敗：${e.message}`, "err");
        }
      });
    });
  }

  async function renderRateChartForView() {
    const { a, b, label } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);

    const todos = await fetchTodos(fromYmd, toYmd);
    const total = todos.length;
    const done = todos.filter(t => t.done).length;
    const rate = total ? Math.round(done / total * 100) : 0;

    if (rateChart) rateChart.destroy();
    rateChart = new Chart(document.getElementById("rateChart"), {
      type: "bar",
      data: { labels: [label], datasets: [{ label: "達成率(%)", data: [rate] }] },
      options: { scales: { y: { beginAtZero: true, max: 100 } } }
    });
  }

  async function renderAll() {
    setTitles();
    setStatus("同期中…", "warn");
    try{
      const { a, b } = currentRange();
      const fromYmd = ymd(a), toYmd = ymd(b);

      if(view === "month"){
        const [schedules, todos] = await Promise.all([
          fetchSchedules(fromYmd, toYmd),
          fetchTodos(fromYmd, toYmd),
        ]);
        renderScheduleMonthCalendar(schedules, todos);
      }else{
        await renderSchedules();
      }

      await renderTodos();
      await renderRateChartForView();
      setStatus("同期OK", "ok");
    }catch(e){
      setStatus(`エラー：${e.message}`, "err");
      console.error(e);
    }
  }

  function setView(v){
    view = v;
    tabs.forEach(t=>t.classList.toggle("active", t.dataset.view===v));
    renderAll();
  }

  // ===== init =====
  schDate.value = todayStr();
  todoDate.value = todayStr();

  // 日付変更で即更新
  schDate.addEventListener("change", ()=>{
    if(view === "day") renderAll();
  });

  // Now線ボタン
  function syncNowBtn(){
    toggleNowLineBtn.textContent = `Now線: ${showNowLine ? "ON" : "OFF"}`;
  }
  syncNowBtn();
  toggleNowLineBtn.addEventListener("click", ()=>{
    showNowLine = !showNowLine;
    localStorage.setItem(NOW_KEY, showNowLine ? "1" : "0");
    syncNowBtn();
    if(view === "day") renderAll();
  });

  tabs.forEach(t=>{
    t.addEventListener("click", ()=>{
      if(t.dataset.view==="month") monthCursor = new Date();
      setView(t.dataset.view);
    });
  });

  addScheduleBtn.addEventListener("click", async ()=>{
    const date = schDate.value || todayStr();
    const time = schTime.value || "";
    const text = (schText.value || "").trim();
    if(!text) return alert("内容を入れてね");

    try{
      await insertSchedule(date, time, text);
      schText.value = "";
      await renderAll();
      setStatus("スケジュールを追加しました", "ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`, "err");
    }
  });

  addTodoBtn.addEventListener("click", async ()=>{
    const text = (todoText.value || "").trim();
    const planned = todoDate.value || todayStr();
    if(!text) return alert("ToDoを入れてね");

    try{
      await insertTodo(text, planned);
      todoText.value = "";
      await renderAll();
      setStatus("ToDoを追加しました", "ok");
    }catch(e){
      setStatus(`追加失敗：${e.message}`, "err");
    }
  });

  refreshAllBtn.addEventListener("click", async ()=>{ await renderAll(); });

  markAllDoneBtn.addEventListener("click", async ()=>{
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    if(!confirm("この範囲のToDoを全部完了にする？")) return;

    try{
      await markAllDoneInRange(fromYmd, toYmd);
      await renderAll();
      setStatus("範囲内ToDoを全部完了にしました", "ok");
    }catch(e){
      setStatus(`一括完了失敗：${e.message}`, "err");
    }
  });

  carryOverNextBtn.addEventListener("click", async ()=>{
    const { a, b } = currentRange();
    const fromYmd = ymd(a), toYmd = ymd(b);
    if(!confirm("この範囲の『未完了』を翌日に持ち越す？")) return;

    try{
      const n = await carryOverUndoneToNextDay(fromYmd, toYmd);
      await renderAll();
      setStatus(n ? `未完了 ${n}件 を翌日に持ち越しました` : "未完了はありません", "ok");
    }catch(e){
      setStatus(`持ち越し失敗：${e.message}`, "err");
    }
  });

  collectOverdueBtn.addEventListener("click", async ()=>{
    if(!confirm("過去日の未完了ToDoを『今日』に集約する？")) return;
    try{
      const n = await collectOverdueToToday();
      await renderAll();
      setStatus(n ? `期限切れ ${n}件 を今日へ集約しました` : "期限切れ未完了はありません", "ok");
    }catch(e){
      setStatus(`集約失敗：${e.message}`, "err");
    }
  });

  renderAll();
</script>
</body>
</html>
